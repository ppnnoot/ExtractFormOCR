2025-11-21 11:23:13,798 - __main__ - INFO - üöÄ API Server logging initialized with rotation and cleanup
2025-11-21 11:23:13,798 - __main__ - INFO - üìÅ Log directory: ./logs
2025-11-21 11:23:13,798 - __main__ - INFO - üìÖ Max retention: 30 days
2025-11-21 11:23:13,855 - api_server - INFO - üöÄ API Server logging initialized with rotation and cleanup
2025-11-21 11:23:13,855 - api_server - INFO - üìÅ Log directory: ./logs
2025-11-21 11:23:13,855 - api_server - INFO - üìÖ Max retention: 30 days
2025-11-21 11:23:13,865 - api_server - INFO - Initializing components in lifespan...
2025-11-21 11:23:13,865 - template_api_manager - INFO - TemplateAPIManager initialized (API: https://ocr.rg.in.th/uapi/api/KOConfiguration-GetFormId, Cache: True)
2025-11-21 11:23:13,865 - template_api_manager - INFO - TemplateAPIManager initialized (API: https://ocr.rg.in.th/uapi/api/KOConfiguration-GetFormId, Cache: True)
2025-11-21 11:23:13,865 - api_server - INFO - Two-Step AI Pipeline initialized successfully
2025-11-21 11:23:13,865 - multi_ocr_adapter - INFO - Initialized OCR engines: ['oneocr']
2025-11-21 11:23:13,865 - api_server - INFO - Multi-OCR Manager initialized: ['oneocr']
2025-11-21 11:23:13,865 - template_api_manager - INFO - TemplateAPIManager initialized (API: https://ocr.rg.in.th/uapi/api/KOConfiguration-GetFormId, Cache: True)
2025-11-21 11:23:13,865 - document_classifier - INFO - Loading document types from Template API...
2025-11-21 11:23:13,865 - template_api_manager - INFO - Fetching all templates from API
2025-11-21 11:23:13,866 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): ocr.rg.in.th:443
2025-11-21 11:23:14,440 - urllib3.connectionpool - DEBUG - https://ocr.rg.in.th:443 "POST /uapi/api/KOConfiguration-GetFormId HTTP/1.1" 200 None
2025-11-21 11:23:14,442 - template_api_manager - DEBUG - Parsed template: HL0000055 - Statement from Hospital
2025-11-21 11:23:14,442 - template_api_manager - DEBUG - Parsed template: HL0000043 - Other medical document
2025-11-21 11:23:14,442 - template_api_manager - DEBUG - Parsed template: HL0000053 - Detail of invoice
2025-11-21 11:23:14,442 - template_api_manager - DEBUG - Parsed template: HL0000050 - Receipt-Bill
2025-11-21 11:23:14,443 - template_api_manager - DEBUG - Parsed template: HL0000051 - E-Receipt
2025-11-21 11:23:14,443 - template_api_manager - DEBUG - Parsed template: HL0000054 - Estimate Medical Expense report, GOP, guarantee email
2025-11-21 11:23:14,443 - template_api_manager - DEBUG - Parsed template: HL0000052 - Invoice
2025-11-21 11:23:14,443 - template_api_manager - INFO - Fetched 7 templates from API
2025-11-21 11:23:14,444 - document_classifier - INFO - Loaded 7 document types from API: ['B07_STATEMENT', 'HL0000043_UNKNOWN', 'B05_HOSPITAL_DETAIL', 'B01_RECEIPT', 'HL0000051_UNKNOWN', 'B06_ESTIMATE_GOP', 'B04_INVOICE']
2025-11-21 11:23:14,444 - api_server - INFO - Document Classifier initialized successfully
2025-11-21 11:23:14,444 - api_server - INFO - Authentication Manager initialized successfully
2025-11-21 11:23:14,445 - security_module - INFO - SECURITY: SYSTEM_STARTUP - {'timestamp': '2025-11-21T11:23:14.445047'}
2025-11-21 11:30:37,614 - api_server - INFO - üì• Received request from 127.0.0.1: ocr_texts=1 items, form_id=HL0000050
2025-11-21 11:30:37,615 - api_server - INFO - Processing 1 OCR texts with Form ID: HL0000050
2025-11-21 11:30:37,615 - template_api_manager - INFO - Getting template for Form ID: HL0000050
2025-11-21 11:30:37,615 - template_api_manager - INFO - Fetching template from API: HL0000050 (attempt 1/3)
2025-11-21 11:30:37,619 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): ocr.rg.in.th:443
2025-11-21 11:30:38,037 - urllib3.connectionpool - DEBUG - https://ocr.rg.in.th:443 "POST /uapi/api/KOConfiguration-GetFormId HTTP/1.1" 200 None
2025-11-21 11:30:38,039 - template_api_manager - DEBUG - Parsed template: HL0000050 - Receipt-Bill
2025-11-21 11:30:38,039 - template_api_manager - INFO - Template fetched successfully: HL0000050
2025-11-21 11:30:38,039 - security_module - INFO - SECURITY: TEMPLATE_API_SUCCESS - system
2025-11-21 11:30:38,042 - template_api_manager - DEBUG - Cached template for formId: HL0000050
2025-11-21 11:30:38,042 - api_server - INFO - Template loaded: Receipt-Bill (Form ID: HL0000050)
2025-11-21 11:30:38,042 - api_server - INFO - üì§ Sending OCR text to AI API for extraction...
2025-11-21 11:30:38,043 - template_api_manager - INFO - Getting template for Form ID: HL0000050
2025-11-21 11:30:38,044 - template_api_manager - INFO - Fetching template from API: HL0000050 (attempt 1/3)
2025-11-21 11:30:38,046 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): ocr.rg.in.th:443
2025-11-21 11:30:38,363 - urllib3.connectionpool - DEBUG - https://ocr.rg.in.th:443 "POST /uapi/api/KOConfiguration-GetFormId HTTP/1.1" 200 None
2025-11-21 11:30:38,365 - template_api_manager - DEBUG - Parsed template: HL0000050 - Receipt-Bill
2025-11-21 11:30:38,365 - template_api_manager - INFO - Template fetched successfully: HL0000050
2025-11-21 11:30:38,365 - security_module - INFO - SECURITY: TEMPLATE_API_SUCCESS - system
2025-11-21 11:30:38,368 - template_api_manager - DEBUG - Cached template for formId: HL0000050
2025-11-21 11:30:38,368 - ai_simple_extraction - INFO - üìä OCR text stats: 4 non-empty lines, 559 characters
2025-11-21 11:30:38,373 - ai_simple_extraction - INFO - AI request saved: ./output/ai_debug/requests/request_20251121_113038_3a476bae.json
2025-11-21 11:30:38,373 - ai_simple_extraction - INFO - üîç Calling AI API (attempt 1/3)
2025-11-21 11:30:38,375 - urllib3.connectionpool - DEBUG - Starting new HTTP connection (1): qdoc.ecmxpert.com:44444
2025-11-21 11:30:47,558 - urllib3.connectionpool - DEBUG - http://qdoc.ecmxpert.com:44444 "POST /v1/chat/completions HTTP/1.1" 200 1009
2025-11-21 11:30:47,591 - ai_simple_extraction - INFO - AI response saved: ./output/ai_debug/responses/response_20251121_113038_3a476bae.json
2025-11-21 11:30:47,591 - ai_simple_extraction - INFO - üìù AI Response (first 500 chars): [K] hospital_name | ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏ô‡∏ó‡πå  
[K] receipt_no | 004  
[K] receipt_date | 5 ‡∏°‡∏Ñ 2565  
[K] patient_name | ‡∏ì‡∏ä‡∏°‡∏ô ‡∏°‡πÄ‡∏ú‡∏≤  
[K] total_amount_in_writing | 150  
[K] cashier_name | ‡∏†‡∏¢‡∏±‡∏Å‡∏£  
[L1] 1.1.1 | ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤ | 150 | - | 150  
[L3] ‡∏â‡∏¢‡∏±‡∏ö | 1 | 150 | - | 150
2025-11-21 11:30:47,594 - ai_simple_extraction - INFO - ‚úÖ Parsed 1 billing items + 1 order items = 2 total items
2025-11-21 11:30:47,594 - ai_simple_extraction - INFO - üìä Extraction ratio: 50.0% (2/4 lines)
2025-11-21 11:30:47,594 - ai_simple_extraction - INFO - ‚úÖ Extraction completed (attempt 1): 2 total items (50.0%), 6 other fields
2025-11-21 11:30:47,594 - api_server - INFO - ‚úÖ AI extraction completed: 1 billing items extracted
2025-11-21 11:30:47,594 - api_server - INFO - üîÑ Mapping extracted keys to template_json structure...
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - Using document_code from template API: HL0000050
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - Using document_type from template API: Receipt-Bill
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - Using template_structure parsed from API
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - üìã Template structure loaded: {
  "documents": [
    {
      "page": "",
      "total_page": "",
      "document_code": "HL0000050",
      "document_info": [
        {
          "code": "hospital_name",
          "page": null,
          "type": "string",
          "value": null,
          "accuracyRate": null
        },
        {
          "code": "hn",
          "page": null,
          "type": "string",
          "value": null,
          "accuracyRate": null
        },
        {
          "code": "vn",
          "page": nul...
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - üìã Template has 16 document_info fields
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - üìã Billing items template structure: 1 template items
2025-11-21 11:30:47,595 - ai_simple_extraction - INFO - üìã First billing item template: {
  "code": "billing_item",
  "page": "",
  "type": "array",
  "value": [
    {
      "code": "billing_code",
      "page": "",
      "type": "string",
      "value": "",
      "accuracyRate": null
    },
    {
      "code": "billing_desc",
      "page": "",
      "type": "string",
      "value": ""...
2025-11-21 11:30:47,597 - ai_simple_extraction - INFO - Building billing items: extracted_count=1, template_count=1
2025-11-21 11:30:47,597 - ai_simple_extraction - DEBUG - Mapped field billing_code from AI field billing_code: 1.1.1
2025-11-21 11:30:47,597 - ai_simple_extraction - DEBUG - Mapped field billing_desc from AI field billing_desc: ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤
2025-11-21 11:30:47,597 - ai_simple_extraction - DEBUG - Mapped field item_level from AI field item_level: 1
2025-11-21 11:30:47,597 - ai_simple_extraction - DEBUG - Mapped field amount from AI field amount: 150
2025-11-21 11:30:47,597 - ai_simple_extraction - DEBUG - Mapped field discount from AI field discount: -
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field net_amount from AI field net_amount: 150
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field billing_code from AI field billing_code: 1.1.11
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field billing_desc from AI field billing_desc: ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field item_level from AI field item_level: 2
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field amount from AI field amount: 0.00
2025-11-21 11:30:47,598 - ai_simple_extraction - DEBUG - Mapped field discount from AI field discount: 0.00
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field net_amount from AI field net_amount: 0.00
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field billing_desc from AI field billing_desc: ‡∏â‡∏¢‡∏±‡∏ö
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field item_level from AI field item_level: 3
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field amount from AI field amount: 150
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field discount from AI field discount: -
2025-11-21 11:30:47,599 - ai_simple_extraction - DEBUG - Mapped field net_amount from AI field net_amount: 150
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field billing_code from AI field billing_code: 1.1.11
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field billing_desc from AI field billing_desc: ‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field item_level from AI field item_level: 2
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field amount from AI field amount: 0.00
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field discount from AI field discount: 0.00
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field net_amount from AI field net_amount: 0.00
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field billing_desc from AI field billing_desc: ‡∏â‡∏¢‡∏±‡∏ö
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field item_level from AI field item_level: 3
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field amount from AI field amount: 150
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field discount from AI field discount: -
2025-11-21 11:30:47,600 - ai_simple_extraction - DEBUG - Mapped field net_amount from AI field net_amount: 150
2025-11-21 11:30:47,600 - ai_simple_extraction - INFO - ‚úÖ Built 1 hierarchical billing items from template
2025-11-21 11:30:47,601 - api_server - INFO - ‚úÖ JSON formatting completed
2025-11-21 11:30:47,603 - api_server - INFO - üìù API response saved: ./output/api_debug/responses/api_response_extract_text_20251121_113047_7bae9c22-1f92-4e17-9b65-83d0698659fb.json
