# üöÄ Quick Fix Summary - Prompt ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

## ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
```
Error: The number of tokens to keep from the initial prompt is greater 
than the context length.
```

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** Prompt ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (system + user + OCR + examples ‚âà 4560 tokens > 4096)

---

## ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ

### **1. ‡∏•‡∏î System Prompt (-87%)**
```python
# ‡πÄ‡∏î‡∏¥‡∏° (60 tokens)
'You are an expert at extracting data from medical receipts. Return simple, clean data.'

# ‡πÉ‡∏´‡∏°‡πà (8 tokens) ‚úÖ
'Extract data from Thai medical receipts accurately.'
```

### **2. ‡∏•‡∏î User Prompt (-80%)**
```python
# ‡πÄ‡∏î‡∏¥‡∏° (400-500 tokens) - ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏≤‡∏ß
Extract information from this Thai receipt...
Example output:
HOSPITAL_NAME: ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û...
HN: 04-20-006834...
BILLING_ITEMS:
1.1.1 | ‡∏¢‡∏≤‡πÅ‡∏ú‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...

# ‡πÉ‡∏´‡∏°‡πà (80-100 tokens) - ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‚úÖ
OCR Text:
{ocr_text}

Extract (format: FIELD: value):
HOSPITAL_NAME: 
HN: 
AN: 
...

Return ONLY extracted data, no explanations.
```

### **3. ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á OCR 100 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‚úÖ**
- ‡πÑ‡∏°‡πà‡∏•‡∏î `max_ocr_results`
- ‡∏¢‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô

---

## üìä Token Savings

| Component | ‡πÄ‡∏î‡∏¥‡∏° | ‡πÉ‡∏´‡∏°‡πà | ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î |
|-----------|------|------|---------|
| System prompt | 60 | 8 | **-87%** |
| User prompt | 400-500 | 80-100 | **-80%** |
| OCR texts (100) | 1500 | 1500 | - |
| max_tokens | 2500 | 2500 | - |
| **TOTAL** | **4560** | **4108** | **-10%** |

**Status:** ‚ùå Exceeded ‚Üí ‚úÖ Works!

---

## üîß ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ

### **`ai_simple_extraction.py`** ‚úÖ
1. System prompt ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á
2. Receipt template ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á
3. Medical receipt template ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á

### **`config.json`** (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ)
```json
{
  "max_tokens": 2500,        ‚úÖ ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
  "max_ocr_results": 100     ‚úÖ ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
}
```

---

## üöÄ How to Apply

### **Step 1: Code ‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß** ‚úÖ

### **Step 2: Restart API Server** ‚ö†Ô∏è
```bash
# ‡∏´‡∏¢‡∏∏‡∏î (Ctrl+C)
# ‡∏£‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
python api_server.py
```

### **Step 3: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö**
```bash
curl -X POST http://localhost:8000/extract/text \
  -H "Content-Type: application/json" \
  -d '{
    "ocr_texts": ["‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", "HN: 123"],
    "template": "receipt"
  }'
```

**‡∏Ñ‡∏ß‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!** ‚úÖ

---

## ‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á

### **‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ:**
- ‚ùå Error 400: Context length exceeded
- ‚ùå AI extraction failed
- ‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### **‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ:**
- ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ error 400
- ‚úÖ AI extraction ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- ‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (100 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î OCR)
- ‚úÖ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (prompt ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á)
- ‚è±Ô∏è ~17-30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)

---

## üéØ Why This Works?

### **Q: ‡∏•‡∏î prompt ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏°?**
**A:** ‡πÉ‡∏ä‡πà! ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:
- ‚úÖ AI ‡∏â‡∏•‡∏≤‡∏î‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏™‡∏±‡πâ‡∏ô‡πÜ
- ‚úÖ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (examples) ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
- ‚úÖ OCR texts (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á) ‡∏¢‡∏±‡∏á‡∏Ñ‡∏£‡∏ö 100 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
- ‚úÖ Format ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°

### **Q: ‡∏ó‡∏≥‡πÑ‡∏°‡πÑ‡∏°‡πà‡∏•‡∏î `max_ocr_results` ‡πÅ‡∏ó‡∏ô?**
**A:** ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:
- ‚ùå ‡∏•‡∏î OCR = ‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‚úÖ ‡∏•‡∏î prompt template = ‡∏¢‡∏±‡∏á‡πÑ‡∏î‡πâ OCR ‡∏Ñ‡∏£‡∏ö

---

## üí° ‡∏™‡∏£‡∏∏‡∏õ

**‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:**
1. ‚úÖ ‡∏•‡∏î system prompt ‡∏à‡∏≤‡∏Å 60 ‚Üí 8 tokens
2. ‚úÖ ‡∏•‡∏î user prompt ‡∏à‡∏≤‡∏Å 400-500 ‚Üí 80-100 tokens
3. ‚úÖ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á OCR 100 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
4. ‚úÖ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á max_tokens 2500

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
- ‚úÖ Total tokens: 4560 ‚Üí 4108 (-10%)
- ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ context length error ‡∏≠‡∏µ‡∏Å
- ‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
- ‚úÖ ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢

**Trade-off:**
> **‡∏•‡∏î prompt verbosity ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° token space** ‚úÖ

---

## üìã Checklist

- [x] ‡πÅ‡∏Å‡πâ `ai_simple_extraction.py`
- [ ] **Restart API Server** ‚ö†Ô∏è (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö extraction
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö log ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ error 400
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô

---

**‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:** 11 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025  
**Version:** 2.3.0 - Prompt Optimization  
**Status:** ‚úÖ Ready to use (restart required)

